name: "Code Review"

on:
  pull_request:
    branches: [develop, main]
    paths-ignore:
      - "**.md"
      - "docs/**"
      - "infrastructure/**"

  pull_request_review_comment:
    types: [created]

concurrency:
  group: review-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  # ============================================
  # CodeQL Security Analysis
  # ============================================
  codeql:
    name: "CodeQL Security"
    runs-on: ubuntu-latest
    timeout-minutes: 20

    permissions:
      contents: read
      security-events: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2

      - name: Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: "25"
          distribution: "temurin"

      - name: Grant execute permission
        run: chmod +x gradlew

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: java-kotlin
          queries: security-and-quality

      - name: Build for CodeQL
        run: ./gradlew classes --no-daemon -x test

      - name: CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:java-kotlin"

  # ============================================
  # Qodana - Java Inspections
  # ============================================
  qodana:
    name: "Qodana Inspection"
    runs-on: ubuntu-latest
    timeout-minutes: 15

    permissions:
      contents: read
      checks: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Qodana Scan
        uses: JetBrains/qodana-action@v2025.3.1
        with:
          args: >-
            --linter jetbrains/qodana-jvm-community:latest --baseline qodana.sarif.json
          pr-mode: false
        env:
          QODANA_TOKEN: ${{ secrets.QODANA_TOKEN }}
        continue-on-error: true