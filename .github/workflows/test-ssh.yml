name: Test SSH Connection

on:
  workflow_dispatch:  # Permite ejecuci√≥n manual

jobs:
  test-ssh-connection:
    name: Test VPS SSH Connection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: üîç Display secrets (masked)
        run: |
          echo "VPS Host: ${{ secrets.VPS_HOST }}"
          echo "VPS Username: ${{ secrets.VPS_USERNAME }}"
          echo "VPS Port: ${{ secrets.VPS_PORT }}"
          echo "SSH Key length: ${#SSH_KEY}"
        env:
          SSH_KEY: ${{ secrets.VPS_SSH_KEY }}

      - name: üîê Test SSH Connection
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            echo "========================================="
            echo "‚úÖ SSH Connection Successful!"
            echo "========================================="
            echo ""
            echo "üìä System Information:"
            echo "- Hostname: $(hostname)"
            echo "- User: $(whoami)"
            echo "- OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d '"' -f 2)"
            echo "- Kernel: $(uname -r)"
            echo ""
            echo "üê≥ Docker Information:"
            docker --version || echo "‚ùå Docker not found"
            docker-compose --version || echo "‚ùå Docker Compose not found"
            echo ""
            echo "üìÅ Directory Check:"
            if [ -d "/opt/conecta-seguros-backend" ]; then
              echo "‚úÖ /opt/conecta-seguros-backend exists"
              ls -la /opt/conecta-seguros-backend
            else
              echo "‚ùå /opt/conecta-seguros-backend does NOT exist"
            fi
            echo ""
            echo "üîê Environment File Check:"
            if [ -f "/opt/conecta-seguros-backend/.env" ]; then
              echo "‚úÖ .env file exists"
              echo "   Permissions: $(ls -la /opt/conecta-seguros-backend/.env | awk '{print $1}')"
            else
              echo "‚ùå .env file NOT found"
            fi
            echo ""
            echo "üìÑ Docker Compose File Check:"
            if [ -f "/opt/conecta-seguros-backend/docker-compose.yml" ]; then
              echo "‚úÖ docker-compose.yml exists"
            else
              echo "‚ùå docker-compose.yml NOT found"
            fi
            echo ""
            echo "üîë Docker Registry Login Test:"
            docker info | grep -i "registry" || true
            echo ""
            echo "üíæ Disk Space:"
            df -h / | tail -1
            echo ""
            echo "üß† Memory:"
            free -h | grep Mem
            echo ""
            echo "========================================="
            echo "‚úÖ All checks completed!"
            echo "========================================="

      - name: üìã Test docker-compose config
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          key: ${{ secrets.VPS_SSH_KEY }}
          port: ${{ secrets.VPS_PORT }}
          script: |
            cd /opt/conecta-seguros-backend
            echo "üîç Validating docker-compose.yml..."
            docker-compose config --quiet && echo "‚úÖ docker-compose.yml is valid" || echo "‚ùå docker-compose.yml has errors"

      - name: üéâ Success Summary
        if: success()
        run: |
          echo "üéâ SSH Connection Test PASSED!"
          echo ""
          echo "‚úÖ GitHub Actions can successfully connect to your VPS"
          echo "‚úÖ All required files are in place"
          echo "‚úÖ Docker is installed and accessible"
          echo ""
          echo "üöÄ You're ready to deploy!"

      - name: ‚ùå Failure Summary
        if: failure()
        run: |
          echo "‚ùå SSH Connection Test FAILED!"
          echo ""
          echo "Please check:"
          echo "1. VPS_HOST is correct (IP or domain)"
          echo "2. VPS_USERNAME is correct"
          echo "3. VPS_SSH_KEY contains the complete private key"
          echo "4. VPS_PORT is correct (usually 22)"
          echo "5. SSH key is added to ~/.ssh/authorized_keys on VPS"
          echo "6. VPS firewall allows SSH connections"